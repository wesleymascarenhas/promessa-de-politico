{% extends "template.html" %}

{% block stylesheets %}
{% endblock %}

{% block content %}
<section class="politician-cover">
  <div id="politician-carousel" class="carousel slide" data-ride="carousel">
    <!-- Wrapper for slides -->
    <div class="carousel-inner">
      {% for coverPhoto in data.politician.related('coverPhotos').models %}
        <div class="item {{ 'active' if loop.first  }}" style="background-image: url('/img/politicians/cover/{{ coverPhoto.get('photo_path') }}');"></div>
      {% endfor %}
    </div>
    <!-- Politician Infos -->
    <div class="politician-infos">
      <div>
        <div class="row">
          <div class="col-md-4 col-md-offset-4">
            <img src="/img/politicians/{{ data.politician.get('photo_path') }}" alt="Dilma Roussef" class="politician-photo img-circle">        
            <h1>
              <p class="bolder-text">
                {{ data.politician.get('name') }}                
              </p>
            </h1>
          </div>
          <div class="promises-stats col-md-4">
            <div>
              <input type="text" value="{{ data.promisesFulfilledPercentage }}" data-readOnly="true" data-width="100" data-height="100" data-fgColor="#5cb85c" data-bgColor="#fff" data-thickness="0.4">
              <h4>Promessas cumpridas (%)</h4>
            </div>
            <div>
              <a href="#" title="Compartilhe as promessas de {{ data.politician.get('name') }} no Facebook" class="icon icon-facebook"></a>
              <a href="#" title="Compartilhe as promessas de {{ data.politician.get('name') }} no Twitter" class="icon icon-twitter"></a>
              <a href="#" title="Compartilhe as promessas de {{ data.politician.get('name') }} no Google+" class="icon icon-googleplus"></a>
            </div>
          </div>
        </div>
      </div>
      <div>
        <h4 class="bolder-text">
          <span>
            Partido: 
            <a href="/partido/{{ data.politician.related('party').get('acronym') }}">
              {{ data.politician.related('party').get('name') }} ({{ data.politician.related('party').get('acronym') }})
            </a>
          </span>
            -
          <span>
            Cargo: {{ data.politician.related('office').get('title') }} 
            {{ "/ politician.related('organ').get('name')" if data.politician.related('organ').id }}
          </span>
        </h4>  
        <h4 class="bolder-text">
          {{ data.politician.get('biography') }}           
        </h4>
        </h4>
      </div>             
      <div class="votes">
        <div class="vote">
          <div class="vote-up">
            <button type="button" class="btn btn-success">
              <span style="font-size: 30px;" class="glyphicon glyphicon-thumbs-up"></span>
            </button>
          </div>
          <div class="vote-count">
            <span class="bolder">350</span>
          </div>
        </div>
        <div class="vote">
          <div class="vote-down">
            <button type="button" class="btn btn-danger">
              <span style="font-size: 30px;" class="glyphicon glyphicon-thumbs-down"></span>
            </button>
          </div>
          <div class="vote-count">
            <span>350</span>
          </div>
        </div>
      </div>             
    </div>
  </div>
</section>
<div class="promises-menu">    
  <ul class="nav nav-pills nav-justified">
    <li class="">
      <a href="/bucketlist" class="view-bucketlist">
        <span class="glyphicon glyphicon-time"></span> Últimas Promessas
      </a>   
    </li>
    <li class="">
      <a href="/users/sandrocsimas/badges">
        <span class="glyphicon glyphicon-globe"></span> Promessas mais Importantes
      </a>
    </li>
    <li class="">
      <a href="/users/sandrocsimas/badges">
        <span class="glyphicon glyphicon-globe"></span> Promessas mais Antigas
      </a>
    </li>
    <li class="active">
      <a href="/users/sandrocsimas">
        <span class="glyphicon glyphicon-th-list"></span> 
        Todas as Promessas ({{ data.totalPromises if data.totalPromises else 0 }})
      </a>
    </li>   
  </ul>
</div>
<section class="promises container">   
  <div class="row">
    <div class="col-md-8 font-big">
      <span class="promise-count">
        <span class="label label-{{ macros.promise_state_css_class('NONE') }}">
          {{ macros.promise_state_label('NONE') }}
          &nbsp;({{ data.totalPromisesByState['NONE'] if data.totalPromisesByState else 0 }})
        </span>
      </span>
      <span class="promise-count">        
        <span class="label label-{{ macros.promise_state_css_class('STARTED') }}">
          {{ macros.promise_state_label('STARTED') }}
          &nbsp;({{ data.totalPromisesByState['STARTED'] if data.totalPromisesByState else 0 }})
        </span>
      </span>
      <span class="promise-count">        
        <span class="label label-{{ macros.promise_state_css_class('FULFILLED') }}">
          {{ macros.promise_state_label('FULFILLED') }}
          &nbsp;({{ data.totalPromisesByState['FULFILLED'] if data.totalPromisesByState else 0 }})
        </span>
      </span>
      <span class="promise-count">        
        <span class="label label-{{ macros.promise_state_css_class('DISCARDED') }}">
          {{ macros.promise_state_label('DISCARDED') }}
          &nbsp;({{ data.totalPromisesByState['DISCARDED'] if data.totalPromisesByState else 0 }})
        </span>
      </span>
    </div>
    <div class="col-md-4 align-right">    
      <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#add-promise">
        <span class="glyphicon glyphicon-plus"></span>
        Registrar Promessa
      </button>
    </div>
  </div>
  <div class="promises-section">
  
  </div>
</section>
<div class="modal fade" id="add-promise" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Registro de Promessa</h4>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/js/jquery.knob.js"></script>
<script type="text/template" id="promises_section_template">
  <% if(model.promises.length > 0) { %>
  <div class="row">
    <div class="col-md-12 align-center">
      <div class="page-header">
        <h1>
        <% if(model.tabId === "allPromises") { %>
          Todas as promessas
        <% } else if(model.tabId === "lastPromises") { %>
          Últimas promessas
        <% } else if(model.tabId === "majorPromises") { %>
          Promessas mais Importantes
        <% } else if(model.tabId === "olderPromises") { %>
          Promessas mais antigas
        <% }%>
        </h1>
        <% if(model.tabId === "allPromises") { %>          
        <h3>
          <span class="label label-info"><%= model.category.name %> (<%= model.promises.length %>)</span>
        </h3>
        <% } %>
      </div>      
    </div>
  </div>
  <div class="row">
    <div class="categories-list col-md-3">
      
    </div>      
    <div class="col-md-9">      
      <ul class="promises-list list-unstyled">
            
      </ul>                  
    </div>
  </div>
  <% } else { %>
  <div class="row">
    <div class="col-md-12 align-center">
      <div class="page-header">
        <h1>
          Nenhuma promessa registrada
        </h1>        
      </div>      
    </div>
  </div>
  <% } %>
</script>
<script type="text/template" id="categories_list_template">
  <div class="panel panel-default">
    <div class="panel-heading">Categorias (<%= collection.length %>)</div>
    <div class="list-group">
      <% _.each(collection, function(model) { %>
      <a class="list-group-item <%= model.id === data.category.id ? 'active' : '' %>" data-category="<%= model.id %>">
        <%= model.name %>
      </a>
      <% }); %>
    </div>
  </div>
</script>
<script type="text/template" id="promise_item_template">  
  <div class="promise-item">
    <div class="promise-title">         
      <h4>         
        <a href="/promessa/<%= model.politicianSlug %>/<%= model.id %>/<%= model.slug %>" class="NONE">
          <%= model.title %>
        </a>
      </h4>
    </div>               
    <div class="promise-infos">
      <div class="row">
        <div class="col-md-10">
          <div class="promise-state">
            <span class="state label label-<%= window.viewHelpers.getPromiseStateCssClass(model.state) %>">
              <%= window.viewHelpers.getPromiseStateLabel(model.state) %>
            </span>
            •
            <span>
              <a class="promise-vote">
                Prioritária
                <%= model.voted === true ? "(Desfazer)" : "" %>
              </a>
            </span>            
            <span>
              •
              <span class="glyphicon glyphicon-star"></span> <%= model.totalVotes %>
              •
              <span class="glyphicon glyphicon-comment"></span> <%= model.totalComments %>                 
              •
              <span class="glyphicon glyphicon-paperclip"></span> <%= model.totalEvidences %>              
            </span>
          </div>
          <div class="promise-author">            
            <%= model.evidence_date !== null ? "Promessa feita há " + moment(model.evidence_date).fromNow() + " • " : "" %>
            Registrada por 
            <a href="/usuario/<%= model.registered_by_user.username %>">
              <%= model.registered_by_user.name %>
            </a>
          </div>
        </div>
        <div class="col-md-2">
          <span class="social pull-right">              
            <a class="icon icon-facebook" href="http://www.facebook.com/sharer/sharer.php?u=www.promessadepolitico.com.br/promessa/<%= model.politicianSlug %>/<%= model.id %>/<%= model.slug %>" title="Compartilhe essa promessa no Facebook" target="_blank"></a>
            <a class="icon icon-twitter" href="http://twitter.com/share?url=www.promessadepolitico.com.br/promessa/<%= model.politicianSlug %>/<%= model.id %>/<%= model.slug %>" title="Compartilhe essa promessa no Twitter" target="_blank"></a>
            <a class="icon icon-googleplus" href="https://plus.google.com/share?url=www.promessadepolitico.com.br/promessa/<%= model.politicianSlug %>/<%= model.id %>/<%= model.slug %>" title="Compartilhe essa promessa no Google+" target="_blank"></a>
          </span>
        </div>
      </div>
    </div>
  </div>            
</script> 
<script>
  $(".promises-stats input").knob();

  var CategoryModel = Backbone.Model.extend();
  var CategoriesCollection = Backbone.Collection.extend({model: CategoryModel});
  var CategoriesView = Backbone.View.extend({
    el: ".categories-list",
    template: _.template($("#categories_list_template").html()),
    events: {
      "click .list-group-item": "selectCategory"
    },
    initialize: function(options) {      
      _.extend(this, _.pick(options, "data"));        
      this.render();
    },
    render: function() {
      this.$el.html(this.template({collection: this.collection.toJSON(), data: this.data}));
      return this;
    },
    selectCategory: function(ev) {
      var view = this;
      var target = $(ev.currentTarget);
      $.get("/politico/" + this.data.politician.id + "/categoria/" + target.data("category") + "/promessas", function(data) {
        view.data.promisesView.collection.set(window.viewHelpers.getPromises(data));
        view.data.promisesView.render();
        view.data.category
        view.render();
      });
    }
  });

  var PromiseModel = Backbone.Model.extend({
    defaults: {
      totalVotes: 0,
      totalComments: 0,
      totalEvidences: 0,
    }
  });
  var PromisesCollection = Backbone.Collection.extend({model: PromiseModel});
  var PromiseView = Backbone.View.extend({
    template: _.template($("#promise_item_template").html()),
    tagName: "li",
    events: {
      "click .promise-vote": "voteInPromise"
    },
    initialize: function() {
      this.listenTo(this.model, 'change', this.render);
    },
    render: function() {      
      this.$el.html(this.template({model: this.model.toJSON()}));
      this.promiseVoteLink = this.$(".promise-vote");
      return this;
    },
    voteInPromise: function() {
      if(this.model.get("voted")) {
        this.model.set({"voted": false, "totalVotes": this.model.get("totalVotes") - 1});
      } else {
        this.model.set({"voted": true, "totalVotes": this.model.get("totalVotes") + 1});
      }
    }
  });
  var PromisesView = Backbone.View.extend({
    el: ".promises-list",
    initialize: function() {
      this.render();
    },
    render: function() { 
      var view = this; 
      view.$el.empty();    
      this.collection.forEach(function(model) {
        var promiseView = new PromiseView({model: model});
        view.$el.append(promiseView.render().el);
      });
      return this;
    }
  });

  var PromisesSectionModel = Backbone.View.extend();
  var PromisesSectionView = Backbone.View.extend({
    template: _.template($("#promises_section_template").html()),
    el: ".promises-section",
    initialize: function() {            
      this.render();
    },
    render: function() {
      console.log(this.template)
      console.log(this.$el)
      console.log(this.model)
      this.$el.html(this.template({model: this.model.toJSON()}));
      this.renderCategories();
      this.renderPromises();
      return this;
    },
    renderCategories: function() {
      var categoriesCollection = new CategoriesCollection(this.model.categories);
      this.categoriesView = new CategoriesView({
        collection: categoriesCollection,
        data: {politician: data.politician, category: data.category}
      });
    },
    renderPromises: function() {
      var promises = window.viewHelpers.getPromises(this.model);
      var promisesCollection = new PromisesCollection(promises);
      this.promisesView = new PromisesView({collection: promisesCollection});
    }
  });

  var data = {{ data|jsonString }};

  var promisesSectionModel = new PromisesSectionModel(data);
  var promisesSectionView = new PromisesSectionView({model: promisesSectionModel});
  
</script>
{% endblock %}